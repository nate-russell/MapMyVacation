<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBHn1WnMhCF-Me1-P0b4p_2wNxePg6JRGA"></script>
    <script src="//d3js.org/d3.v3.min.js"></script>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <style type="text/css">


        #top {
            margin-left: 10px;
            font-weight: bold;
        }

        #main {
            width: 80%;
            height: 90%;
            margin: 0;
            padding: 0;
            display: flex;
        }

        #rhs {
        }

        #lhs {
        }

        #description {
            width: 400px;
            height: 110px;
            margin-top: 0px;
            margin-left: 5px;
            padding-left: 5px;
            border-radius: 2px;
            border-style: solid;
            border-width: 1px;
            border-color: lightgrey;
            box-shadow: lightgrey;
        }

        #album {
            width: 400px;
            height: 4px;
            margin-left: 5px;
            padding-left: 5px;
        }

        h1 {
            color: dodgerblue;
            font-weight: bold;
        }

        h2 {
            color: dodgerblue;
        }

        h4 {
            color: lightslategrey;
        }

html, body, #map {
    width: 800px;
    height: 500px;
  margin: 0;
  padding: 0;
}

.marker {
  fill: orange;
  stroke: black;
  stroke-width: 1.5px;
}

.marker:hover {
  cursor: crosshair;
}

.stations {
  background-color: rgba(0,0,0,0);
}

    </style>
  </head>
  <body>
  <div id="top">
      <h2> Map My Vacation (Code Under Development)</h2><a href="https://github.com/nate-russell/MapMyVacation"> Github
      repo</a>
  </div>
  <div id="main">
      <div id="lhs">
          <div id="map"></div>
      </div>
      <div id="rhs">
          <div id="description">
              <h2 id="album_title"></h2>
              <h4 id="album_text"></h4>
          </div>
          <div id="album">
              <blockquote id="album_block" class="imgur-embed-pub" lang="en">
                  <a id="album_a">View Photos on Imgur</a>
              </blockquote>
              <script async src="//s.imgur.com/min/embed.js" charset="utf-8"></script>
          </div>
      </div>
  </div>


  <script type="text/javascript">

      var album_div = document.getElementById("album");
      var og_album_div = jQuery.extend(true, {}, album_div);
      //var og_album_div = jQuery.clone(album_div);
      var album_title = document.getElementById("album_title");
      var album_text = document.getElementById("album_text");
      var album_block = document.getElementById("album_block");
      var album_a = document.getElementById("album_a");

      console.log(og_album_div)


// Create the Google Map…
var map = new google.maps.Map(d3.select("#map").node(), {
  zoom: 1,
  center: new google.maps.LatLng(37.76487, -122.41948),
  mapTypeId: google.maps.MapTypeId.TERRAIN
});



// Load the station data. When the data comes back, create an overlay.
d3.json("data.json", function(data) {
  // fit the map to the boundaries of all available data points and
  // ONCE generate google LatLng objects to be re-used repeatedly
  var bounds = new google.maps.LatLngBounds();
  d3.entries(data).forEach(function(d){
    bounds.extend(d.value.lat_lng = new google.maps.LatLng(d.value.lat, d.value.lng));
  });
    map.fitBounds(bounds);

  var overlay = new google.maps.OverlayView(),
      r = 30,
      m = 6,
      padding = r * m;
  // Add the container when the overlay is added to the map.
  overlay.onAdd = function() {
    var layer = d3.select(this.getPanes().overlayMouseTarget)
        .append("svg")
        .attr('class','stations');
    overlay.draw = function(){
      var projection = this.getProjection(),
          sw = projection.fromLatLngToDivPixel(bounds.getSouthWest()),
          ne = projection.fromLatLngToDivPixel(bounds.getNorthEast());
      // extend the boundaries so that markers on the edge aren't cut in half
      sw.x -= padding;
      sw.y += padding;
      ne.x += padding;
      ne.y -= padding;

      d3.select('.stations')
        .attr('width',(ne.x - sw.x) + 'px')
        .attr('height',(sw.y - ne.y) + 'px')
        .style('position','absolute')
        .style('left',sw.x+'px')
        .style('top',ne.y+'px');

      var marker = layer.selectAll('.marker')
        .data(d3.entries(data))
        .each(transform)
        .each(transformc);

      // Add Patterns for every image
        /**
      var defs = marker.enter().append('svg:defs');

      d3.entries(data).forEach(function(d){
          defs.append("svg:pattern")
                  .attr("id", d.key)
                  .attr("width", r*m)
                  .attr("height", r*m)
                  .attr("x", 0)
                  .attr("y", 0)
                  .attr("patternUnits", "userSpaceOnUse")
                  //.attr("patternContentUnits", "objectBoundingBox")
                  .append("svg:image")
                  .attr("xlink:href", d.value.img)
                  .attr("padding",0)
                  .attr("width", r*m)
                  .attr("height", r*m)
                  .attr("cx", function(d) {
                        d = projection.fromLatLngToDivPixel(d.value.lat_lng);
                        return d.x;})
                  .attr("cy", function(d) {
                        d = projection.fromLatLngToDivPixel(d.value.lat_lng);
                        return d.y;});
      });



      var circle = marker.enter().append('svg:circle')
        .attr('class','marker')
        .attr('r',r)
         .style("fill", function(d){return 'url(#'+d.key+')';})
         .style("stroke", "black")
         .style("stroke-width", 1)
        .on("mouseover", function(d){d3.select(this)
                   .style("fill", 'url(#'+d.key+')')
                   .attr("r", r*3);})
          .on("mouseout", function(d){d3.select(this)
                   .style("fill", 'url(#'+d.key+')')
                   .attr("r", r);})

        .attr('cx',function(d) {
          d = projection.fromLatLngToDivPixel(d.value.lat_lng);
          return d.x-sw.x;
        })
        .attr('cy',function(d) {
          d = projection.fromLatLngToDivPixel(d.value.lat_lng);
          return d.y-ne.y;
        })
        .append('title').text(function(d){

          return d.key;
        });


      var circle = marker.enter().append('svg:circle')
        .attr('class','marker')
        .attr('r',r)
         .style("fill", function(d){return 'url(#'+d.key+')';})
         .style("stroke", "black")
         .style("stroke-width", 1)
        .on("mouseover", function(d){d3.select(this)
                   .style("fill", 'url(#'+d.key+')')
                   .attr("r", r*3);})
          .on("mouseout", function(d){d3.select(this)
                   .style("fill", 'url(#'+d.key+')')
                   .attr("r", r);})

        .attr('cx',function(d) {
          d = projection.fromLatLngToDivPixel(d.value.lat_lng);
          return d.x-sw.x;
        })
        .attr('cy',function(d) {
          d = projection.fromLatLngToDivPixel(d.value.lat_lng);
          return d.y-ne.y;
        })
        .append('title').text(function(d){

          return d.key;
        });



      var clippath = marker.enter().append("clipPath")       // define a clip path
          .attr("id", function(d){return d.key+'_clip';}) // give the clipPath an ID
          .append("ellipse")          // shape it as an ellipse
          .attr('cx',function(d) {
              d = projection.fromLatLngToDivPixel(d.value.lat_lng);
              return d.x-sw.x+(r/2);
          })
          .attr('cy',function(d) {
              d = projection.fromLatLngToDivPixel(d.value.lat_lng);
              return d.y-ne.y+(r/2);
          })
          .attr("rx", 10)         // set the x radius
          .attr("ry", 10)
          .on("mouseout", function(d){d3.select(this)
              .attr('cx',function(d) {
                    d = projection.fromLatLngToDivPixel(d.value.lat_lng);
                    return d.x-sw.x+(r/2);
              })
              .attr('cy',function(d) {
                    d = projection.fromLatLngToDivPixel(d.value.lat_lng);
                    return d.y-ne.y+(r/2);
              })
              .attr("rx", 10)         // set the x radius
              .attr("ry", 10);
          })
          .on("mouseover", function(d){d3.select(this)
              .attr('cx',function(d) {
                    d = projection.fromLatLngToDivPixel(d.value.lat_lng);
                    return d.x-sw.x+(r*m/2);
              })
              .attr('cy',function(d) {
                    d = projection.fromLatLngToDivPixel(d.value.lat_lng);
                    return d.y-ne.y+(r*m/2);
              })
              .attr("rx", 10*m)         // set the x radius
              .attr("ry", 10*m);
          });         // set the y radius
       **/

      var image = marker.enter().append('svg:image')
          .attr('class','marker')
          .attr("xlink:href",  function(d) {return d.value.img;})
          .attr("height", r)
          .attr("width", r)
            .style("stroke", "black")
            .style("stroke-width", 5)
            .attr("preserveAspectRatio", "xMidYMid slice")
          .attr("clip-path", function(d){return "url(#"+d.key+"_clip)";}) // clip the image
          .on("mouseover", function(d){d3.select(this)
              .attr("height", r*m)
              .attr("width", r * m)
              //.attr('x',function(d) {
              //dd = projection.fromLatLngToDivPixel(d.value.lat_lng);
              //return dd.x - sw.x - (r * m / 2);
              //})
              //.attr('y',function(d) {
              //dd = projection.fromLatLngToDivPixel(d.value.lat_lng);
              //return dd.y - ne.y - (r * m / 2);
              //})
          })
          .on("mouseout", function(d){d3.select(this)
              .attr("height", r)
              .attr("width", r)
              //.attr('x',function(d) {
              //dd = projection.fromLatLngToDivPixel(d.value.lat_lng);
              //return dd.x - sw.x + (r * m / 2);
              //})
              //.attr('y',function(d) {
              //dd = projection.fromLatLngToDivPixel(d.value.lat_lng);
              //return dd.y - ne.y + (r * m / 2);
              //})
          })
            .on('click', function (d) {
                d3.select(this)

                // Update Text
                album_text.textContent = d.key
                album_title.textContent = d.key

                // Update Album Div Clone
                album_block.setAttribute('data-id', d.value.albumid)
                album_a.setAttribute('href', "//imgur.com/" + d.value.albumid)
                console.log('Post Update album_block')
                console.log(album_block.outerHTML)

                // Inject the HTML content
                album_div.innerHTML = album_block.outerHTML

                // Re-Add Embed script that transforms blockquote into iframe
                var imported = document.createElement('script')
                imported.src = '//s.imgur.com/min/embed.js'
                document.body.appendChild(imported)
                ;

          })
          .attr('x',function(d) {
              d = projection.fromLatLngToDivPixel(d.value.lat_lng);
              return d.x - sw.x - (r / 2);
          })
          .attr('y',function(d) {
              d = projection.fromLatLngToDivPixel(d.value.lat_lng);
              return d.y - ne.y - (r / 2);
          });

      function transform(d) {
        d = projection.fromLatLngToDivPixel(d.value.lat_lng);
        return d3.select(this)
          .attr('x',d.x-sw.x)
          .attr('y',d.y-ne.y);
      }
      function transformc(d) {
        d = projection.fromLatLngToDivPixel(d.value.lat_lng);
        return d3.select(this)
          .attr('cx',d.x-sw.x)
          .attr('cy',d.y-ne.y);
      }
    };
  };

  // Bind our overlay to the map…
    overlay.setMap(map);
});

    </script>
  </body>
</html>